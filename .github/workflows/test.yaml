name: Tests

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: '1.22'
          cache-dependency-path: test/go.sum

      - name: Install Helm
        env:
          HELM_VERSION: v3.17.0
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash -s -- --version ${HELM_VERSION}

      - name: Set up chart-testing
        uses: helm/chart-testing-action@e6669bcd63d7cb57cb4380c33043eebe5d111992 # v2

      - name: Chart lint
        run: ct lint --chart-dirs . --charts .

      - name: Unit tests
        run: make test-unit

  chart-testing:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Install Helm
        env:
          HELM_VERSION: v3.17.0
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash -s -- --version ${HELM_VERSION}

      - name: Set up chart-testing
        uses: helm/chart-testing-action@e6669bcd63d7cb57cb4380c33043eebe5d111992 # v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build pgedge-helm-utils dev image
        run: make docker-build-dev

      - name: Install Kind
        env:
          KIND_VERSION: v0.27.0
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create Kind cluster and install prerequisites
        run: make -C test kind-up

      - name: Load image into Kind
        run: make -C test kind-load-image

      - name: Chart install test
        run: ct install --chart-dirs . --charts . --target-branch main --upgrade --skip-missing-values --github-groups --helm-extra-set-args "--set pgEdge.initSpockImageName=pgedge-helm-utils:dev"

      - name: Teardown
        if: always()
        run: make -C test kind-down

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: '1.22'
          cache-dependency-path: test/go.sum

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build pgedge-helm-utils dev image
        run: make docker-build-dev

      - name: Install tools
        env:
          KIND_VERSION: v0.27.0
          HELM_VERSION: v3.17.0
        run: |
          # Install kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

          # Install Helm
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash -s -- --version ${HELM_VERSION}

      - name: Create Kind cluster and install prerequisites
        run: make -C test kind-up

      - name: Load image into Kind
        run: make -C test kind-load-image

      - name: Integration tests
        run: make -C test test-integration KUBECONTEXT=kind-pgedge-test INIT_SPOCK_IMAGE=pgedge-helm-utils:dev TIMEOUT=10m

      - name: Collect debug artifacts on failure
        if: failure()
        run: |
          mkdir -p /tmp/artifacts

          kind export logs /tmp/artifacts/kind-logs --name pgedge-test || true

          kubectl get pods -A -o wide > /tmp/artifacts/pods.txt || true
          kubectl get events -A --sort-by='.lastTimestamp' > /tmp/artifacts/events.txt || true

          helm list -A > /tmp/artifacts/helm-releases.txt || true
          helm get all pgedge -n default > /tmp/artifacts/helm-release-details.txt || true

          kubectl get jobs -n default > /tmp/artifacts/jobs.txt || true
          kubectl describe job pgedge-init-spock -n default > /tmp/artifacts/init-spock-job.txt || true
          kubectl logs -l job-name=pgedge-init-spock -n default --all-containers=true > /tmp/artifacts/init-spock-logs.txt || true

          kubectl get clusters.postgresql.cnpg.io -n default > /tmp/artifacts/pg-clusters.txt || true
          kubectl describe clusters.postgresql.cnpg.io -n default > /tmp/artifacts/pg-cluster-details.txt || true
          kubectl logs -l cnpg.io/cluster -n default --all-containers=true --tail=500 > /tmp/artifacts/postgres-logs.txt || true

      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: debug-logs
          path: /tmp/artifacts

      - name: Teardown
        if: always()
        run: make -C test kind-down
