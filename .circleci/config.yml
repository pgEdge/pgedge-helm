version: 2.1
commands:
  install-tools:
    parameters:
      kind-version:
        type: string
        default: v0.22.0
      helm-version:
        type: string
        default: v3.14.1
      kubectl-version:
        type: string
        default: v1.29.2
    steps:
      - restore_cache:
          keys:
            - kind-<<parameters.kind-version>>-helm-<<parameters.helm-version>>-kubectl-<<parameters.kubectl-version>>
      - run:
          name: Install tools
          command: |
            kind_version=<<parameters.kind-version>>
            helm_version=<<parameters.helm-version>>
            kubectl_version=<<parameters.kubectl-version>>

            mkdir -p ~/.local/bin
            cd ~/.local/bin

            if [[ ! -x ./kind ]]; then
              curl -Lo ./kind "https://kind.sigs.k8s.io/dl/${kind_version}/kind-linux-amd64"
              chmod +x ./kind
            fi

            if [[ ! -x ./helm ]]; then
              curl -Lo helm.tar.gz "https://get.helm.sh/helm-${helm_version}-linux-amd64.tar.gz"
              tar -xz --strip-components 1 -f helm.tar.gz linux-amd64/helm
              chmod +x ./helm
              rm helm.tar.gz
            fi
            
            if [[ ! -x ./kubectl ]]; then
              curl -LO "https://dl.k8s.io/release/${kubectl_version}/bin/linux/amd64/kubectl"
              chmod +x ./kubectl
            fi

            echo 'export PATH=~/.local/bin:${PATH}' >> $BASH_ENV
      - save_cache:
          key: kind-<<parameters.kind-version>>-helm-<<parameters.helm-version>>-kubectl-<<parameters.kubectl-version>>
          paths:
            - ~/.local/bin/kind
            - ~/.local/bin/helm
            - ~/.local/bin/kubectl
jobs:
  helm-test:
    machine:
      image: ubuntu-2204:2024.01.1
      docker_layer_caching: true
    resource_class: large
    steps:
      - checkout
      - install-tools
      - run:
          name: Set up Docker Buildx
          command: |
            docker buildx create --use --name builder || docker buildx use builder
      - run:
          name: Build pgedge-helm-utils dev image
          command: |
            make docker-build-dev
      - run:
          name: Helm lint
          command: |
            helm lint . --values examples/configs/single/values.yaml
      - run:
          name: Cluster up
          command: |
            make -f examples/Makefile single-up
      - run:
          name: Load image into kind
          command: |
            make -f examples/Makefile single-load-kind
      - run:
          name: Install pgedge
          command: |
            make -f examples/Makefile single-install
      - run:
          name: Helm test
          command: |
            make -f examples/Makefile single-test
      - run:
          name: Collect debug artifacts on failure
          when: on_fail
          command: |
            mkdir -p /tmp/artifacts

            # Get kind cluster logs
            kind export logs /tmp/artifacts/kind-logs --name single || true

            # Get all pods
            kubectl get pods -A -o wide > /tmp/artifacts/pods.txt || true

            # Get all events
            kubectl get events -A --sort-by='.lastTimestamp' > /tmp/artifacts/events.txt || true

            # Get helm release info
            helm list -A > /tmp/artifacts/helm-releases.txt || true
            helm get all pgedge -n default > /tmp/artifacts/helm-release-details.txt || true

            # Get init-spock job logs
            kubectl get jobs -n default > /tmp/artifacts/jobs.txt || true
            kubectl describe job pgedge-init-spock -n default > /tmp/artifacts/init-spock-job.txt || true
            kubectl logs -l job-name=pgedge-init-spock -n default --all-containers=true > /tmp/artifacts/init-spock-logs.txt || true

            # Get PostgreSQL cluster info
            kubectl get clusters.postgresql.cnpg.io -n default > /tmp/artifacts/pg-clusters.txt || true
            kubectl describe clusters.postgresql.cnpg.io -n default > /tmp/artifacts/pg-cluster-details.txt || true

            # Get PostgreSQL pod logs
            kubectl logs -l cnpg.io/cluster -n default --all-containers=true --tail=500 > /tmp/artifacts/postgres-logs.txt || true
      - store_artifacts:
          path: /tmp/artifacts
          destination: debug-logs
      - run:
          name: Teardown
          when: always
          command: |
            make -f examples/Makefile single-uninstall || true
            make -f examples/Makefile single-down || true

workflows:
  test:
    jobs:
      - helm-test
